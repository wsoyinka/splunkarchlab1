---
# tasks file for forwarders

- name: add splunk user
  become: yes
  user:
    name: "{{ uf_system_user }}"
    comment: "Splunk service user"
    createhome: yes
 #   system: yes
  tags:
   - createuser


- name: download installer for splunk
  command: "wget -O {{ uf_installer_dest  }} {{ uf_installer_url }} "
  tags:
   - downloadufwget



- name: install UF splunk binary
  become: yes
  tags:
   - installuf
  unarchive:
    src: "{{ uf_installer_dest  }}"
    dest: /opt/
    copy: no
    owner: "{{ splunk_system_user }}"
    group: "{{ splunk_system_user }}"
    creates: "{{ uf_path }}/bin/splunk"


- name: accept splunk license on forwarders
  become: yes
  become_user: "{{ splunk_system_user }}"
  command: "{{ uf_path  }}/bin/splunk start --accept-license --answer-yes"
  args:
   creates: "{{ uf_path  }}/etc/users/splunk-system-user"
  environment:
   SPLUNK_HOME: "/opt/splunkforwarder"
  tags:
   - start_uf

- name: setup splunk to start at boot on forwarders
  become: yes
#  become_user: "{{ splunk_system_user }}"
  command: "{{ uf_path  }}/bin/splunk enable boot-start -user splunk --accept-license --answer-yes"
  args:
   creates: "{{ uf_path }}/etc/users/splunk-system-user"
  environment:
   SPLUNK_HOME: "/opt/splunkforwarder"
  tags:
   - start_uf_boot

- name:  change splunk admin forwarders
  become: yes
  become_user: "{{ splunk_system_user }}"
  command: "{{ uf_path  }}/bin/splunk edit user admin -auth {{ splunk_admin }}:changeme -password {{ splunk_pass  }}"
  environment:
   SPLUNK_HOME: "{{ uf_path  }}"
  tags:
   - set_password1


- name: set default hostname and set servername fwd1
  become: yes
  become_user: "{{ splunk_system_user }}"
  command: "{{ item }}"
  with_items:
  - "{{ uf_path  }}/bin/splunk set servername  {{ fwd1_name }} -auth {{ splunk_admin }}:{{ splunk_pass }}"
  - "{{ uf_path  }}/bin/splunk set default-hostname {{ fwd1_name }} -auth {{ splunk_admin }}:{{ splunk_pass }} "
  tags:
   - setsplunk-hostname_fwd1
  notify: restart splunk

- name: set default hostname and set servername fwd2
  become: yes
  become_user: "{{ splunk_system_user }}"
  command: "{{ item }}"
  with_items:
  - "{{ uf_path  }}/bin/splunk set servername  {{ fwd2_name }} -auth {{ splunk_admin }}:{{ splunk_pass }}"
  - "{{ uf_path  }}/bin/splunk set default-hostname {{ fwd2_name }} -auth {{ splunk_admin }}:{{ splunk_pass }} "
  tags:
   - setsplunk-hostname_fwd2
  notify: restart splunk

- name:  set deployment.conf from cli
  become: yes
  become_user: "{{ splunk_system_user }}"
  command: "{{ uf_path }}/bin/splunk set deploy-poll  {{ deployment_server_address }}:8089  -auth {{ splunk_admin }}:{{ splunk_pass  }}"
  environment:
   SPLUNK_HOME: "{{ uf_path }}"
  tags:
   - configure_uf_d_cli
  notify: restart splunk


- name: template out outputs.conf
  become: yes
  become_user: "{{ splunk_system_user }}"
  tags:
   - configure_uf_o
  template:
    src: outputs.conf.j2
    dest: "{{ uf_path }}/etc/system/local/outputs.conf"
    owner: "{{ splunk_system_user }}"
    group: "{{ splunk_system_user }}"

- name: template out inputs.conf
  become: yes
  become_user: "{{ splunk_system_user }}"
  tags:
   - configure_uf_i
  template:
    src: inputs.conf.j2
    dest: "{{ uf_path }}/etc/system/local/inputs.conf"
    owner: "{{ splunk_system_user }}"
    group: "{{ splunk_system_user }}"


#- name: template deploymentclient.conf
#  become: yes
#  become_user: "{{ splunk_system_user }}"
#  tags:
#   - configure_uf_d
#  template:
#    src: deploymentclient.conf.j2
#    dest: "{{ uf_path }}/etc/system/local/deploymentclient.conf.wale"
#    owner: "{{ splunk_system_user }}"
#    group: "{{ splunk_system_user }}"
